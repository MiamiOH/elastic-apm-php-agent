<?php

use Swaggest\JsonSchema\Schema;
use Swaggest\PhpCodeBuilder\PhpCode;

require_once __DIR__ . '/vendor/autoload.php';

chdir(__DIR__ . '/schemas/apm-6.5');

$context = new \Swaggest\JsonSchema\Context(new \PhilKra\Schema\RefProvider());

$swaggerSchema = \Swaggest\JsonSchema\Schema::import(
    'docs/spec/transactions/v1_transaction.json',
    $context
);

chdir(__DIR__);

$sourcePath = __DIR__ . '/src/Apm/V1';
ensurePath($sourcePath);

$appPath = realpath($sourcePath);

$namespaceRoot = 'PhilKra\Apm\V1';

$app = new \Swaggest\PhpCodeBuilder\App\PhpApp();
$app->setNamespaceRoot($namespaceRoot, '.');

$builder = new \Swaggest\PhpCodeBuilder\JsonSchema\PhpBuilder();
$builder->buildSetters = true;
$builder->makeEnumConstants = true;

//$builder->classPreparedHook = new \Swaggest\PhpCodeBuilder\JsonSchema\ClassHookCallback(
//    function (\Swaggest\PhpCodeBuilder\PhpClass $class, string $path, Schema $schema) use ($app, $namespaceRoot) {
//        if (1 == 1) {
//            echo "here\n";
//        }
//    }
//);

$builder->classCreatedHook = new \Swaggest\PhpCodeBuilder\JsonSchema\ClassHookCallback(
    function (\Swaggest\PhpCodeBuilder\PhpClass $class, string $path, Schema $schema) use ($app, $namespaceRoot) {
        $desc = '';
        if ($schema->title) {
            $desc = $schema->title;
        }
        if ($schema->description) {
            $desc .= "\n" . $schema->description;
        }
        if ($fromRefs = $schema->getFromRefs()) {
            $desc .= "\nBuilt from " . implode("\n" . ' <- ', $fromRefs);
        }

        $class->setDescription(trim($desc));

        print "Starting path: $path\n";
        if (strpos($path, '.json') !== false) {
            $path = str_replace('.json', '', $path);
        }

        $schemaPathPrefix = 'docs/spec/';
        if (strpos($path, $schemaPathPrefix) === 0) {
            $path = substr($path, strlen($schemaPathPrefix));
        }

        $class->setNamespace(getNameSpaceForPath($path, $namespaceRoot));

        $class->setName(\Swaggest\PhpCodeBuilder\PhpCode::makePhpClassName($path));
        print "Name is: " . $class->getFullyQualifiedName() . "\n";

        $app->addClass($class);
    }
);

$builder->getType($swaggerSchema);
$app->clearOldFiles($appPath);
$app->store($appPath);

function getNameSpaceForPath(string $path, string $namespaceRoot): string
{
    $pathParts = explode('->', $path);
    array_shift($pathParts);

    return $namespaceRoot . PhpCode::makePhpNamespaceName($pathParts);
}

function ensurePath(string $path) {
    if (file_exists($path)) {
        return;
    }

    if (!mkdir($path, 0777, true) && !is_dir($path)) {
        throw new \RuntimeException(sprintf('Directory "%s" was not created', $path));
    }
}